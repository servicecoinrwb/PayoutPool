<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PayoutPool Admin Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #000000 0%, #18181b 50%, #000000 100%);
      min-height: 100vh;
      color: #ffffff;
      padding: 1.5rem;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .logo {
      padding: 0.75rem;
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      border-radius: 0.75rem;
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
    }
    
    .logo svg {
      width: 2rem;
      height: 2rem;
      stroke: white;
      fill: none;
      stroke-width: 2;
    }
    
    h1 {
      font-size: 1.875rem;
      font-weight: bold;
      margin-bottom: 0.25rem;
    }
    
    .subtitle {
      color: #9ca3af;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .btn {
      padding: 0.5rem 1.5rem;
      border-radius: 0.5rem;
      border: none;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s;
      font-size: 0.875rem;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: linear-gradient(to right, #ea580c, #f97316);
      color: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    
    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(to right, #c2410c, #ea580c);
      transform: translateY(-1px);
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid #3f3f46;
      color: white;
    }
    
    .btn-outline:hover:not(:disabled) {
      border-color: #52525b;
    }
    
    .btn-danger {
      background: linear-gradient(to right, #dc2626, #ef4444);
      color: white;
    }
    
    .btn-danger:hover:not(:disabled) {
      background: linear-gradient(to right, #b91c1c, #dc2626);
    }
    
    .btn svg {
      width: 1rem;
      height: 1rem;
    }
    
    .alert {
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
      animation: slideIn 0.3s ease-out;
      display: none;
    }
    
    .alert.show {
      display: block;
    }
    
    .alert-success {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid #22c55e;
      color: #86efac;
    }
    
    .alert-error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      color: #fca5a5;
    }
    
    .alert-info {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid #3b82f6;
      color: #93c5fd;
    }
    
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .grid {
      display: grid;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .grid-4 {
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }
    
    .grid-2 {
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }
    
    .card {
      background: linear-gradient(135deg, #18181b 0%, #27272a 100%);
      border: 1px solid #3f3f46;
      border-radius: 0.75rem;
      padding: 1.25rem;
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
      transition: border-color 0.3s;
    }
    
    .card:hover {
      border-color: #52525b;
    }
    
    .stat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    
    .stat-title {
      color: #9ca3af;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 0.25rem;
    }
    
    .stat-subtitle {
      font-size: 0.75rem;
      color: #6b7280;
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    
    .icon-box {
      padding: 0.5rem;
      background: rgba(249, 115, 22, 0.2);
      border-radius: 0.5rem;
    }
    
    .icon-box svg {
      width: 1.25rem;
      height: 1.25rem;
      stroke: #fb923c;
    }
    
    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
    }
    
    .section-subtitle {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    
    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: #e5e7eb;
      margin-bottom: 0.375rem;
    }
    
    input, textarea {
      width: 100%;
      padding: 0.5rem 1rem;
      background: #27272a;
      border: 1px solid #3f3f46;
      border-radius: 0.5rem;
      color: white;
      font-size: 0.875rem;
      font-family: inherit;
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: #f97316;
    }
    
    input:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    textarea {
      resize: vertical;
      font-family: 'Courier New', monospace;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-hint {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }
    
    .notice {
      text-align: center;
      padding: 1.25rem;
    }
    
    .notice svg {
      width: 2rem;
      height: 2rem;
      margin: 0 auto 0.5rem;
      display: block;
    }
    
    .notice-info {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid #3b82f6;
      color: #93c5fd;
    }
    
    .notice-warning {
      background: rgba(234, 88, 12, 0.2);
      border: 1px solid #ea580c;
      color: #fdba74;
    }
    
    .hidden {
      display: none !important;
    }
    
    .spinner {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .icon-sm {
      width: 1rem;
      height: 1rem;
    }
    
    .icon-md {
      width: 1.25rem;
      height: 1.25rem;
    }
    
    .icon-success {
      stroke: #22c55e;
    }
    
    .icon-orange {
      stroke: #fb923c;
    }
    
    .flex-end {
      display: flex;
      align-items: flex-end;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .header-right {
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <div class="logo">
          <svg viewBox="0 0 24 24">
            <circle cx="8" cy="8" r="6"/><circle cx="16" cy="16" r="6"/>
          </svg>
        </div>
        <div>
          <h1>PayoutPool Admin</h1>
          <div class="subtitle">
            <span>Arbitrum Network</span>
            <span>•</span>
            <span>USDC Payouts</span>
            <svg id="chainOkIcon" class="icon-sm icon-success hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
        </div>
      </div>
      <div class="header-right">
        <button id="refreshBtn" class="btn btn-outline" title="Refresh balances">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          <span>Refresh</span>
        </button>
        <button id="connectBtn" class="btn btn-primary">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
          </svg>
          Connect Wallet
        </button>
      </div>
    </div>

    <!-- Alert -->
    <div id="alertBox" class="alert"></div>

    <!-- Stats -->
    <div class="grid grid-4">
      <div class="card">
        <div class="stat-header">
          <div class="stat-title">Pool Balance</div>
          <svg class="icon-md icon-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <circle cx="8" cy="8" r="6"/><circle cx="16" cy="16" r="6"/>
          </svg>
        </div>
        <div id="poolBalance" class="stat-value">0.0 USDC</div>
      </div>

      <div class="card">
        <div class="stat-header">
          <div class="stat-title">Your Balance</div>
          <svg class="icon-md icon-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
          </svg>
        </div>
        <div id="userBalance" class="stat-value">0.0 USDC</div>
      </div>

      <div class="card">
        <div class="stat-header">
          <div class="stat-title">Contract Status</div>
          <svg id="statusIcon" class="icon-md icon-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div id="contractStatus" class="stat-value">Active</div>
        <div id="contractStatusSub" class="stat-subtitle">Payouts enabled</div>
      </div>

      <div class="card">
        <div class="stat-header">
          <div class="stat-title">Owner Status</div>
          <svg class="icon-md icon-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
        </div>
        <div id="ownerStatus" class="stat-value">—</div>
        <div id="ownerAddress" class="stat-subtitle">—</div>
      </div>
    </div>

    <!-- Addresses -->
    <div class="card" style="margin-bottom: 1.5rem;">
      <div class="grid grid-2">
        <div>
          <label>Pool Contract Address</label>
          <input id="poolAddr" type="text" value="0x9dEe14f92CCfA6736c7FaC1ddfc23C9b83b13f92">
        </div>
        <div>
          <label>USDC Token Address</label>
          <input id="usdcAddr" type="text" value="0xaf88d065e77c8cC2239327C5EDb3A432268e5831">
        </div>
      </div>
    </div>

    <!-- Connect Notice -->
    <div id="connectNotice" class="card notice notice-info">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <p>Connect your wallet to start managing payouts</p>
    </div>

    <!-- Not Owner Notice -->
    <div id="notOwnerNotice" class="card notice notice-warning hidden">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
      </svg>
      <p>You are not the contract owner. Admin functions are disabled.</p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
      <!-- Deposit -->
      <div class="card" style="margin-bottom: 1.5rem;">
        <div class="section-header">
          <div class="icon-box">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
          </div>
          <div>
            <div class="section-title">Deposit USDC</div>
            <div class="section-subtitle">Add funds to the payout pool</div>
          </div>
        </div>
        <div class="grid grid-2">
          <div>
            <label>Amount (USDC)</label>
            <input id="depositAmount" type="text" placeholder="200.00">
          </div>
          <div class="flex-end">
            <button id="depositBtn" class="btn btn-primary" style="width: 100%;">Deposit</button>
          </div>
        </div>
      </div>

      <!-- Batch Payout -->
      <div class="card" style="margin-bottom: 1.5rem;">
        <div class="section-header">
          <div class="icon-box">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
          </div>
          <div>
            <div class="section-title">Batch Payout</div>
            <div class="section-subtitle">Send USDC to multiple recipients</div>
          </div>
        </div>
        
        <!-- Batch Summary -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: rgba(249, 115, 22, 0.1); border: 1px solid rgba(249, 115, 22, 0.3); border-radius: 0.5rem;">
          <div>
            <div style="font-size: 0.75rem; color: #9ca3af; margin-bottom: 0.25rem;">Available to Send</div>
            <div id="availableToSend" style="font-size: 1.25rem; font-weight: bold; color: #fb923c;">0 USDC</div>
          </div>
          <div>
            <div style="font-size: 0.75rem; color: #9ca3af; margin-bottom: 0.25rem;">Recipients</div>
            <div id="recipientCount" style="font-size: 1.25rem; font-weight: bold;">0</div>
          </div>
          <div>
            <div style="font-size: 0.75rem; color: #9ca3af; margin-bottom: 0.25rem;">Total to Send</div>
            <div id="totalToSend" style="font-size: 1.25rem; font-weight: bold; color: #22c55e;">0 USDC</div>
          </div>
          <div>
            <div style="font-size: 0.75rem; color: #9ca3af; margin-bottom: 0.25rem;">Remaining After</div>
            <div id="remainingAfter" style="font-size: 1.25rem; font-weight: bold;">0 USDC</div>
          </div>
        </div>
        
        <div class="grid grid-2">
          <div>
            <label>Recipients CSV (address,amount)</label>
            <textarea id="batchCsv" rows="6" placeholder="0x1234...5678,100.50&#10;0xabcd...efgh,250.00"></textarea>
            <div class="form-hint">Max 75 recipients • One per line • Amounts in USDC</div>
          </div>
          <div>
            <div class="form-group">
              <label>Payout ID (optional)</label>
              <input id="payoutId" type="text" placeholder="friday-payroll">
            </div>
            <button id="batchBtn" class="btn btn-primary" style="width: 100%;">Send Batch</button>
            <p id="pausedWarning" class="form-hint hidden" style="color: #fb923c; margin-top: 0.5rem;">Contract is paused</p>
            <p id="insufficientWarning" class="form-hint hidden" style="color: #ef4444; margin-top: 0.5rem;">⚠️ Insufficient pool balance</p>
          </div>
        </div>
      </div>

      <!-- Admin Controls -->
      <div id="adminControls" class="hidden">
        <div class="grid grid-2" style="margin-bottom: 1.5rem;">
          <!-- Pause/Unpause -->
          <div class="card">
            <div class="section-header">
              <div class="icon-box">
                <svg id="pauseIconSvg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <div>
                <div class="section-title">Contract Control</div>
                <div class="section-subtitle">Pause or resume operations</div>
              </div>
            </div>
            <button id="pauseBtn" class="btn btn-primary" style="width: 100%;">Pause Contract</button>
          </div>

          <!-- Withdraw -->
          <div class="card">
            <div class="section-header">
              <div class="icon-box">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                </svg>
              </div>
              <div>
                <div class="section-title">Withdraw</div>
                <div class="section-subtitle">Remove USDC from pool</div>
              </div>
            </div>
            <div class="form-group">
              <label>Amount (USDC)</label>
              <input id="withdrawAmount" type="text" placeholder="100.00">
            </div>
            <button id="withdrawBtn" class="btn btn-primary" style="width: 100%;">Withdraw</button>
          </div>
        </div>

        <!-- Transfer Ownership -->
        <div class="card">
          <div class="section-header">
            <div class="icon-box" style="background: rgba(220, 38, 38, 0.2);">
              <svg fill="none" stroke="#f87171" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
              </svg>
            </div>
            <div>
              <div class="section-title">Transfer Ownership</div>
              <div class="section-subtitle" style="color: #f87171;">⚠️ This action is irreversible</div>
            </div>
          </div>
          <div class="grid grid-2">
            <div>
              <label>New Owner Address</label>
              <input id="newOwner" type="text" placeholder="0x..." style="font-family: 'Courier New', monospace;">
            </div>
            <div class="flex-end">
              <button id="transferBtn" class="btn btn-danger" style="width: 100%;">Transfer</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Last Transaction -->
      <div id="lastTxCard" class="card hidden" style="margin-top: 1.5rem; background: rgba(24, 24, 27, 0.5);">
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <span style="font-size: 0.875rem; color: #9ca3af;">Last Transaction:</span>
          <a id="lastTxLink" href="#" target="_blank" rel="noopener noreferrer" style="font-size: 0.875rem; color: #fb923c; font-family: 'Courier New', monospace; text-decoration: none;"></a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State
    let state = {
      account: '',
      chainId: 0,
      owner: '',
      paused: false,
      poolBalance: '0',
      userBalance: '0',
      decimals: 6,
      busy: false
    };

    // Known function selectors for your contract
    const FUNCTION_SELECTORS = {
      'owner()': '0x8da5cb5b',
      'paused()': '0x5c975abb',
      'getPoolBalance()': '0x4ab91f55',
      'decimals()': '0x313ce567',
      'balanceOf(address)': '0x70a08231',
      'approve(address,uint256)': '0x095ea7b3',
      'deposit(uint256)': '0xb6b55f25',
      'batchPayout(string,address[],uint256[])': '0x8b0e9f3f',
      'pause()': '0x8456cb59',
      'unpause()': '0x3f4ba83a',
      'emergencyWithdraw()': '0xdb2e21bc',
      'transferOwnership(address)': '0xf2fde38b'
    };

    function getSelector(method, paramTypes) {
      const sig = `${method}(${paramTypes.join(',')})`;
      
      // Try to find in known selectors first
      if (FUNCTION_SELECTORS[sig]) {
        return FUNCTION_SELECTORS[sig].slice(2);
      }
      
      // Fallback to simple hash
      let hash = 0;
      for (let i = 0; i < sig.length; i++) {
        hash = ((hash << 5) - hash) + sig.charCodeAt(i);
        hash = hash & hash;
      }
      return Math.abs(hash).toString(16).padStart(8, '0');
    }

    function encodeFunction(method, paramTypes, params) {
      const selector = getSelector(method, paramTypes);
      console.log('Encoding function:', method, 'selector:', selector);
      
      let encoded = '';
      let dynamicData = '';
      let dynamicOffset = params.length * 32;
      
      for (let i = 0; i < params.length; i++) {
        const type = paramTypes[i];
        const param = params[i];
        
        if (type === 'uint256') {
          encoded += BigInt(param).toString(16).padStart(64, '0');
        } else if (type === 'address') {
          encoded += param.slice(2).toLowerCase().padStart(64, '0');
        } else if (type === 'bool') {
          encoded += (param ? '1' : '0').padStart(64, '0');
        } else if (type === 'address[]' || type === 'uint256[]' || type === 'string') {
          encoded += dynamicOffset.toString(16).padStart(64, '0');
          
          if (type === 'address[]') {
            let arrayData = param.length.toString(16).padStart(64, '0');
            for (const addr of param) {
              arrayData += addr.slice(2).toLowerCase().padStart(64, '0');
            }
            dynamicData += arrayData;
            dynamicOffset += (1 + param.length) * 32;
          } else if (type === 'uint256[]') {
            let arrayData = param.length.toString(16).padStart(64, '0');
            for (const num of param) {
              arrayData += BigInt(num).toString(16).padStart(64, '0');
            }
            dynamicData += arrayData;
            dynamicOffset += (1 + param.length) * 32;
          } else if (type === 'string') {
            const hex = Array.from(param).map(c => c.charCodeAt(0).toString(16).padStart(2, '0')).join('');
            const len = (hex.length / 2).toString(16).padStart(64, '0');
            const paddedHex = hex.padEnd(Math.ceil(hex.length / 64) * 64, '0');
            dynamicData += len + paddedHex;
            dynamicOffset += 32 + paddedHex.length / 2;
          }
        }
      }
      
      const fullData = '0x' + selector + encoded + dynamicData;
      console.log('Encoded data:', fullData);
      return fullData;
    }

    function decodeResult(type, data) {
      const cleaned = data.startsWith('0x') ? data.slice(2) : data;
      
      if (type === 'uint256' || type === 'uint8') {
        return '0x' + cleaned;
      } else if (type === 'address') {
        return '0x' + cleaned.slice(-40);
      } else if (type === 'bool') {
        return parseInt(cleaned, 16) !== 0;
      }
      return data;
    }

    function formatUnits(value, decimals) {
      // Handle hex string
      if (typeof value === 'string' && value.startsWith('0x')) {
        value = BigInt(value);
      } else if (typeof value === 'string') {
        value = BigInt(value);
      }
      
      const num = BigInt(value);
      const divisor = BigInt(10 ** decimals);
      const whole = num / divisor;
      const remainder = num % divisor;
      const remainderStr = remainder.toString().padStart(decimals, '0');
      const trimmed = remainderStr.replace(/0+$/, '') || '0';
      const result = `${whole}.${trimmed}`;
      console.log('formatUnits:', value, '->', result);
      return result;
    }

    function parseUnits(value, decimals) {
      const [whole, fraction = ''] = value.split('.');
      const paddedFraction = fraction.padEnd(decimals, '0').slice(0, decimals);
      return '0x' + (BigInt(whole) * BigInt(10 ** decimals) + BigInt(paddedFraction)).toString(16);
    }

    function isValidAddress(address) {
      return /^0x[a-fA-F0-9]{40}$/.test(address);
    }

    // UI helpers
    function showAlert(type, msg) {
      const alertBox = document.getElementById('alertBox');
      alertBox.className = `alert alert-${type} show`;
      alertBox.textContent = msg;
      setTimeout(() => alertBox.classList.remove('show'), 5000);
    }

    function setBusy(busy) {
      state.busy = busy;
      document.querySelectorAll('button').forEach(btn => {
        btn.disabled = busy;
      });
    }

    function updateUI() {
      document.getElementById('poolBalance').textContent = 
        parseFloat(formatUnits(state.poolBalance, state.decimals)).toLocaleString() + ' USDC';
      document.getElementById('userBalance').textContent = 
        parseFloat(formatUnits(state.userBalance, state.decimals)).toLocaleString() + ' USDC';
      
      // Update available to send
      document.getElementById('availableToSend').textContent = 
        parseFloat(formatUnits(state.poolBalance, state.decimals)).toLocaleString() + ' USDC';
      
      document.getElementById('contractStatus').textContent = state.paused ? 'Paused' : 'Active';
      document.getElementById('contractStatusSub').textContent = state.paused ? 'Payouts disabled' : 'Payouts enabled';
      document.getElementById('pausedWarning').classList.toggle('hidden', !state.paused);
      
      const isOwner = state.account && state.owner && 
        state.account.toLowerCase() === state.owner.toLowerCase();
      
      document.getElementById('ownerStatus').textContent = isOwner ? 'You' : 'Not Owner';
      document.getElementById('ownerAddress').textContent = state.owner ? 
        `${state.owner.slice(0,6)}…${state.owner.slice(-4)}` : '—';
      
      document.getElementById('connectNotice').classList.toggle('hidden', !!state.account);
      document.getElementById('mainContent').classList.toggle('hidden', !state.account);
      document.getElementById('notOwnerNotice').classList.toggle('hidden', !state.account || isOwner);
      document.getElementById('adminControls').classList.toggle('hidden', !isOwner);
      
      document.getElementById('pauseBtn').textContent = state.paused ? 'Unpause Contract' : 'Pause Contract';
      
      document.getElementById('poolAddr').disabled = !!state.account;
      document.getElementById('usdcAddr').disabled = !!state.account;
      
      // Update batch calculation when CSV changes
      calculateBatchTotal();
    }
    
    function calculateBatchTotal() {
      const csv = document.getElementById('batchCsv').value;
      if (!csv.trim()) {
        document.getElementById('recipientCount').textContent = '0';
        document.getElementById('totalToSend').textContent = '0 USDC';
        document.getElementById('remainingAfter').textContent = 
          parseFloat(formatUnits(state.poolBalance, state.decimals)).toLocaleString() + ' USDC';
        document.getElementById('insufficientWarning').classList.add('hidden');
        return;
      }
      
      try {
        const lines = csv.trim().split('\n').filter(l => l.trim());
        let total = 0;
        
        for (const line of lines) {
          const [addr, amt] = line.split(',').map(s => s.trim());
          if (amt && !isNaN(parseFloat(amt))) {
            total += parseFloat(amt);
          }
        }
        
        const poolBal = parseFloat(formatUnits(state.poolBalance, state.decimals));
        const remaining = poolBal - total;
        
        document.getElementById('recipientCount').textContent = lines.length.toString();
        document.getElementById('totalToSend').textContent = total.toLocaleString() + ' USDC';
        document.getElementById('remainingAfter').textContent = remaining.toLocaleString() + ' USDC';
        
        // Show warning if insufficient balance
        const insufficient = total > poolBal;
        document.getElementById('insufficientWarning').classList.toggle('hidden', !insufficient);
        document.getElementById('totalToSend').style.color = insufficient ? '#ef4444' : '#22c55e';
        document.getElementById('remainingAfter').style.color = insufficient ? '#ef4444' : '#ffffff';
        
      } catch (err) {
        console.error('Error calculating batch:', err);
      }
    }

    // Contract calls
    async function callContract(address, method, paramTypes, params = []) {
      const data = encodeFunction(method, paramTypes, params);
      const result = await window.ethereum.request({
        method: 'eth_call',
        params: [{ to: address, data: data }, 'latest']
      });
      return result;
    }

    async function sendTransaction(address, method, paramTypes, params = []) {
      const data = encodeFunction(method, paramTypes, params);
      console.log('Sending transaction:', method, 'with data:', data);
      const txHash = await window.ethereum.request({
        method: 'eth_sendTransaction',
        params: [{
          from: state.account,
          to: address,
          data: data,
          gas: '0x' + (500000).toString(16) // Add explicit gas limit
        }]
      });
      
      let receipt = null;
      let attempts = 0;
      while (!receipt && attempts < 60) {
        await new Promise(resolve => setTimeout(resolve, 2000));
        receipt = await window.ethereum.request({
          method: 'eth_getTransactionReceipt',
          params: [txHash]
        });
        attempts++;
      }
      
      if (!receipt) {
        throw new Error('Transaction timeout - please check your wallet');
      }
      
      return txHash;
    }

    async function loadInfo() {
      if (!state.account) return;
      
      try {
        const poolAddr = document.getElementById('poolAddr').value;
        const usdcAddr = document.getElementById('usdcAddr').value;
        
        console.log('=== Loading contract data ===');
        console.log('Pool address:', poolAddr);
        console.log('USDC address:', usdcAddr);
        console.log('Connected account:', state.account);
        
        // Load owner first to debug
        try {
          const ownerData = await callContract(poolAddr, 'owner', []);
          console.log('Raw owner data:', ownerData);
          state.owner = decodeResult('address', ownerData);
          console.log('Decoded owner:', state.owner);
          console.log('Account:', state.account);
          console.log('Match:', state.owner.toLowerCase() === state.account.toLowerCase());
        } catch (err) {
          console.error('Error loading owner:', err);
          throw new Error('Failed to load owner: ' + err.message);
        }
        
        // Load paused status
        try {
          const pausedData = await callContract(poolAddr, 'paused', []);
          console.log('Raw paused data:', pausedData);
          state.paused = decodeResult('bool', pausedData);
          console.log('Paused:', state.paused);
        } catch (err) {
          console.error('Error loading paused status:', err);
          throw new Error('Failed to load paused status: ' + err.message);
        }
        
        // Load pool balance
        try {
          const balanceData = await callContract(poolAddr, 'getPoolBalance', []);
          console.log('Raw pool balance data:', balanceData);
          state.poolBalance = decodeResult('uint256', balanceData);
          console.log('Pool balance (wei):', state.poolBalance);
        } catch (err) {
          console.error('Error loading pool balance:', err);
          throw new Error('Failed to load pool balance: ' + err.message);
        }
        
        // Load decimals
        try {
          const decimalsData = await callContract(usdcAddr, 'decimals', []);
          console.log('Raw decimals data:', decimalsData);
          state.decimals = parseInt(decodeResult('uint8', decimalsData), 16);
          console.log('Decimals:', state.decimals);
        } catch (err) {
          console.error('Error loading decimals:', err);
          throw new Error('Failed to load decimals: ' + err.message);
        }
        
        // Load user balance
        try {
          const userBalData = await callContract(usdcAddr, 'balanceOf', ['address'], [state.account]);
          console.log('Raw user balance data:', userBalData);
          state.userBalance = decodeResult('uint256', userBalData);
          console.log('User balance (wei):', state.userBalance);
        } catch (err) {
          console.error('Error loading user balance:', err);
          throw new Error('Failed to load user balance: ' + err.message);
        }
        
        console.log('=== Final State ===');
        console.log('Pool Balance:', formatUnits(state.poolBalance, state.decimals), 'USDC');
        console.log('User Balance:', formatUnits(state.userBalance, state.decimals), 'USDC');
        console.log('Owner:', state.owner);
        console.log('Paused:', state.paused);
        
        updateUI();
        showAlert('success', 'Contract data loaded successfully');
      } catch (err) {
        console.error('Failed to load contract data:', err);
        console.error('Error stack:', err.stack);
        showAlert('error', `Failed to load contract data: ${err.message}`);
      }
    }

    // Event handlers
    document.getElementById('connectBtn').onclick = async () => {
      try {
        if (!window.ethereum) {
          showAlert('error', 'No wallet found. Please install MetaMask.');
          return;
        }
        
        console.log('Connecting wallet...');
        const accounts = await window.ethereum.request({ 
          method: 'eth_requestAccounts' 
        });
        
        const chainIdHex = await window.ethereum.request({ 
          method: 'eth_chainId' 
        });
        
        state.chainId = parseInt(chainIdHex, 16);
        state.account = accounts[0];
        
        console.log('Connected account:', state.account);
        console.log('Chain ID:', state.chainId);
        
        const isArbitrum = state.chainId === 42161 || state.chainId === 421614;
        document.getElementById('chainOkIcon').classList.toggle('hidden', !isArbitrum);
        
        if (!isArbitrum) {
          showAlert('error', `Please switch to Arbitrum network (current: ${state.chainId})`);
        } else {
          showAlert('success', 'Wallet connected successfully');
          await loadInfo();
        }
        
        document.getElementById('connectBtn').innerHTML = `
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
          </svg>
          ${state.account.slice(0,6)}…${state.account.slice(-4)}
        `;
        
        updateUI();
      } catch (err) {
        console.error('Connection error:', err);
        showAlert('error', err.message || 'Failed to connect wallet');
      }
    };

    document.getElementById('refreshBtn').onclick = loadInfo;

    // Add event listener for CSV changes to update batch calculation
    document.getElementById('batchCsv').addEventListener('input', calculateBatchTotal);

    document.getElementById('depositBtn').onclick = async () => {
      const amount = document.getElementById('depositAmount').value;
      if (!amount) return;
      
      setBusy(true);
      try {
        const poolAddr = document.getElementById('poolAddr').value;
        const usdcAddr = document.getElementById('usdcAddr').value;
        const amt = parseUnits(amount, state.decimals);
        
        console.log('Depositing amount:', amount, 'as wei:', amt);
        
        showAlert('info', 'Step 1/2: Approving USDC...');
        await sendTransaction(usdcAddr, 'approve', ['address', 'uint256'], [poolAddr, amt]);
        
        showAlert('info', 'Step 2/2: Depositing USDC...');
        const txHash = await sendTransaction(poolAddr, 'deposit', ['uint256'], [amt]);
        
        document.getElementById('lastTxLink').textContent = `${txHash.slice(0,8)}...${txHash.slice(-6)} ↗`;
        document.getElementById('lastTxLink').href = `https://arbiscan.io/tx/${txHash}`;
        document.getElementById('lastTxCard').classList.remove('hidden');
        
        showAlert('success', `Deposited ${amount} USDC successfully!`);
        document.getElementById('depositAmount').value = '';
        
        // Wait a bit then refresh
        showAlert('info', 'Refreshing balances...');
        await new Promise(resolve => setTimeout(resolve, 2000));
        await loadInfo();
      } catch (err) {
        console.error('Deposit error:', err);
        showAlert('error', err.message || 'Deposit failed');
      } finally {
        setBusy(false);
      }
    };

    document.getElementById('batchBtn').onclick = async () => {
      const csv = document.getElementById('batchCsv').value;
      if (!csv) return;
      
      setBusy(true);
      try {
        const lines = csv.trim().split('\n').filter(l => l.trim());
        if (lines.length === 0) throw new Error('Empty CSV');
        if (lines.length > 75) throw new Error('Max 75 recipients');
        
        const recipients = [];
        const amounts = [];
        let totalAmount = 0;
        
        for (const line of lines) {
          const [addr, amt] = line.split(',').map(s => s.trim());
          if (!isValidAddress(addr)) throw new Error(`Invalid address: ${addr}`);
          recipients.push(addr);
          const amountWei = parseUnits(amt, state.decimals);
          amounts.push(amountWei);
          totalAmount += parseFloat(amt);
        }
        
        // Check if sufficient balance
        const poolBal = parseFloat(formatUnits(state.poolBalance, state.decimals));
        if (totalAmount > poolBal) {
          throw new Error(`Insufficient balance. Need ${totalAmount} USDC but only have ${poolBal} USDC`);
        }
        
        const id = document.getElementById('payoutId').value || `payout-${Date.now()}`;
        showAlert('info', `Sending ${totalAmount.toFixed(2)} USDC to ${recipients.length} recipients...`);
        
        const poolAddr = document.getElementById('poolAddr').value;
        // FIXED: Correct parameter order for your contract: (string, address[], uint256[])
        const txHash = await sendTransaction(poolAddr, 'batchPayout', 
          ['string', 'address[]', 'uint256[]'], [id, recipients, amounts]);
        
        document.getElementById('lastTxLink').textContent = `${txHash.slice(0,8)}...${txHash.slice(-6)} ↗`;
        document.getElementById('lastTxLink').href = `https://arbiscan.io/tx/${txHash}`;
        document.getElementById('lastTxCard').classList.remove('hidden');
        
        showAlert('success', `Batch payout sent! Total: ${totalAmount.toFixed(2)} USDC to ${recipients.length} recipients`);
        document.getElementById('batchCsv').value = '';
        document.getElementById('payoutId').value = '';
        await loadInfo();
      } catch (err) {
        console.error('Batch error:', err);
        showAlert('error', err.message || 'Batch payout failed');
      } finally {
        setBusy(false);
      }
    };

    document.getElementById('pauseBtn').onclick = async () => {
      setBusy(true);
      try {
        const poolAddr = document.getElementById('poolAddr').value;
        const method = state.paused ? 'unpause' : 'pause';
        await sendTransaction(poolAddr, method, []);
        showAlert('success', state.paused ? 'Contract unpaused' : 'Contract paused');
        await loadInfo();
      } catch (err) {
        showAlert('error', err.message || 'Pause/unpause failed');
      } finally {
        setBusy(false);
      }
    };

    document.getElementById('withdrawBtn').onclick = async () => {
      const amount = document.getElementById('withdrawAmount').value;
      if (!amount) return;
      
      setBusy(true);
      try {
        const poolAddr = document.getElementById('poolAddr').value;
        const amt = parseUnits(amount, state.decimals);
        // Using emergencyWithdraw which takes no parameters
        const txHash = await sendTransaction(poolAddr, 'emergencyWithdraw', []);
        
        document.getElementById('lastTxLink').textContent = `${txHash.slice(0,8)}...${txHash.slice(-6)} ↗`;
        document.getElementById('lastTxLink').href = `https://arbiscan.io/tx/${txHash}`;
        document.getElementById('lastTxCard').classList.remove('hidden');
        
        showAlert('success', `Emergency withdrawal completed`);
        document.getElementById('withdrawAmount').value = '';
        await loadInfo();
      } catch (err) {
        console.error('Withdraw error:', err);
        showAlert('error', err.message || 'Withdrawal failed');
      } finally {
        setBusy(false);
      }
    };

    document.getElementById('transferBtn').onclick = async () => {
      const newOwner = document.getElementById('newOwner').value;
      if (!newOwner || !isValidAddress(newOwner)) {
        showAlert('error', 'Invalid address');
        return;
      }
      
      setBusy(true);
      try {
        const poolAddr = document.getElementById('poolAddr').value;
        await sendTransaction(poolAddr, 'transferOwnership', ['address'], [newOwner]);
        showAlert('success', 'Ownership transferred');
        document.getElementById('newOwner').value = '';
        await loadInfo();
      } catch (err) {
        showAlert('error', err.message || 'Transfer failed');
      } finally {
        setBusy(false);
      }
    };

    updateUI();
  </script>
</body>
</html>
